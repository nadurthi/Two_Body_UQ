function H=radar_sens_jac(x,Srad,Radmodel)
x=x(1:3);
x=x(:);
[xenu,R,p]=vec_radar_coordchange(x,Srad,Radmodel.RadPos,'ecef2local');
% x=x'-ecef_ref(Srad,:);
% xenu = ecef2enu(x*1e3,ecef_ref(Srad,:)*1e3)/1000;

r=norm(xenu);
th=atan2(xenu(1),xenu(2));
phi=atan2(sqrt(xenu(1)^2+xenu(2)^2),xenu(3));

if abs(phi)>Radmodel.SensParas(Srad,1) || r > Radmodel.SensParas(Srad,2)
    H=zeros(3,6);
    return;
end

x1=x(1);
x2=x(2);
x3=x(3);

xr1=p(1);
xr2=p(2);
xr3=p(3);

r11=R(1,1);
r12=R(1,2);
r13=R(1,3);

r21=R(2,1);
r22=R(2,2);
r23=R(2,3);

r31=R(3,1);
r32=R(3,2);
r33=R(3,3);


H=[(2*r11*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r21*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) + 2*r31*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + (r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2)^(1/2)),              (2*r12*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r22*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) + 2*r32*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + (r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2)^(1/2)),           (2*r13*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r23*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) + 2*r33*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + (r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2)^(1/2));
   (r11/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) - (r21*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)))/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + 1),    (r12/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) - (r22*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)))/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + 1),    (r13/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) - (r23*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)))/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + 1);
  -((r31*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2))/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 - (2*r11*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r21*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2)*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))))/(((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 + 1), -((r32*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2))/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 - (2*r12*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r22*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2)*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))))/(((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 + 1), -((r33*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2))/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 - (2*r13*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r23*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2)*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))))/(((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 + 1)];

H=[H,zeros(3)];


% 
% syms x1 x2 x3 xr1 xr2 xr3
% syms r11 r12 r13 r21 r22 r23 r31 r32 r33
% Rot=[r11,r12,r13;r21,r22,r23;r31,r32,r33];
% xloc=Rot*([x1;x2;x3]-[xr1;xr2;xr3]);
% 
% xloc=[r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3);
%       r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3);
%       r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3)];
%   
%   h=[sqrt(xloc(1)^2+xloc(2)^2+xloc(3)^2);atan(xloc(1)/xloc(2));atan(sqrt(xloc(1)^2+xloc(2)^2)/xloc(3))]
%   
%   H=[diff(h(1),x1),diff(h(1),x2),diff(h(1),x3);
%      diff(h(2),x1),diff(h(2),x2),diff(h(2),x3);
%      diff(h(3),x1),diff(h(3),x2),diff(h(3),x3)]
%  
%  
% H=[(2*r11*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r21*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) + 2*r31*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + (r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2)^(1/2)),              (2*r12*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r22*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) + 2*r32*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + (r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2)^(1/2)),           (2*r13*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r23*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) + 2*r33*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + (r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2)^(1/2));
%    (r11/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) - (r21*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)))/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + 1),    (r12/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) - (r22*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)))/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + 1),    (r13/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)) - (r23*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)))/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2/(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2 + 1);
%   -((r31*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2))/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 - (2*r11*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r21*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2)*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))))/(((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 + 1), -((r32*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2))/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 - (2*r12*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r22*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2)*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))))/(((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 + 1), -((r33*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2))/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 - (2*r13*(r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3)) + 2*r23*(r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3)))/(2*((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)^(1/2)*(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))))/(((r11*(x1 - xr1) + r12*(x2 - xr2) + r13*(x3 - xr3))^2 + (r21*(x1 - xr1) + r22*(x2 - xr2) + r23*(x3 - xr3))^2)/(r31*(x1 - xr1) + r32*(x2 - xr2) + r33*(x3 - xr3))^2 + 1)];
% 
